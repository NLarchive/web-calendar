<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Client-side modular web appointment calendar scheduler with day, week, month, and year views, recurring events, and multi-format sync." />
    <title>Web Appointment System</title>
    <link rel="stylesheet" href="./public/styles.css" />
  </head>
  <body>
    <div id="app">
      <header id="navbar"></header>
      <main class="layout">
        <section class="panel form-panel">
          <h3>Upcoming</h3>
          <div id="appointment-list"></div>
        </section>
        <section class="panel calendar-panel">
          <div class="panel-header">
            <h2>Calendar</h2>
            <div id="current-datetime" aria-live="polite"></div>
          </div>
          <div id="calendar"></div>
        </section>
      </main>
      <aside id="info-panel" class="info-panel hidden"></aside>
      <div id="appointment-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="appointment-modal-title">
        <div class="modal-card">
          <button id="close-appointment-modal" class="modal-close-sticky" aria-label="Close new appointment popup">✕</button>
          <div class="modal-header">
            <h2 id="appointment-modal-title">New Appointment</h2>
          </div>
          <div id="appointment-form"></div>
        </div>
      </div>
      <div id="appointment-details-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="appointment-details-modal-title">
        <div class="modal-card">
          <button id="close-appointment-details-modal" class="modal-close-sticky" aria-label="Close appointment details popup">✕</button>
          <div class="modal-header">
            <h2 id="appointment-details-modal-title">Appointment Details</h2>
          </div>
          <div id="appointment-details-content"></div>
        </div>
      </div>
      <div id="sync-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="sync-modal-title">
        <div class="modal-card">
          <button id="close-sync-modal" class="modal-close-sticky" aria-label="Close sync popup">✕</button>
          <div class="modal-header">
            <h2 id="sync-modal-title">Sync Calendar</h2>
          </div>
          <form id="sync-form" class="form-grid">
            <label for="sync-action-label">Action</label>
            <input id="sync-action-label" type="text" value="Sync" readonly />
            
            <label for="sync-format">Format</label>
            <select id="sync-format" name="format">
              <option value="auto">Auto (best for selected app)</option>
              <option value="json">JSON (.json)</option>
              <option value="csv">CSV (.csv)</option>
              <option value="ics">iCalendar (.ics)</option>
            </select>

            <label for="sync-target-app">Target App</label>
            <select id="sync-target-app" name="targetApp">
              <option value="download">Download only</option>
              <option value="google">Google Calendar</option>
              <option value="outlook">Outlook</option>
              <option value="ical">iCalendar / Apple Calendar</option>
            </select>

            <button class="primary" type="submit">Run Sync</button>
          </form>
          <p class="small">After download, you must import the saved file into your calendar app to load appointments.</p>
          <p class="small">In Sync App mode, format is selected automatically based on the target app.</p>
          <p class="small">Supported formats: JSON, CSV, and iCalendar (.ics). Load State also accepts .json, .csv, and .ics.</p>
          <p class="small">Google/Outlook/iCalendar sync uses export/import flow for client-side compatibility.</p>
        </div>
      </div>
      <div id="state-load-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="state-load-modal-title">
        <div class="modal-card">
          <button id="close-state-load-modal" class="modal-close-sticky" aria-label="Close load state popup">✕</button>
          <div class="modal-header">
            <h2 id="state-load-modal-title">Load State</h2>
          </div>
          <form id="state-load-form" class="form-grid">
            <label for="load-state-source">Source</label>
            <select id="load-state-source" name="source">
              <option value="sample">Sample State</option>
              <option value="custom">Custom State</option>
              <option value="empty">Empty State</option>
            </select>

            <div id="sample-state-fields">
              <label for="load-state-sample">Sample</label>
              <select id="load-state-sample" name="sample">
                <option value="dog-vet-care-state.json">Dog Vet Care Schedule</option>
                <option value="cat-vet-care-state.json">Cat Vet Care Schedule</option>
                <option value="combined-vet-care-state.json">Combined Vet Care Schedule</option>
              </select>
            </div>
            <div id="custom-state-fields" class="hidden">
              <label for="load-state-file">State File</label>
              <input id="load-state-file" type="file" accept=".json,.csv,.ics,application/json,text/csv,text/calendar" />
            </div>
            <button class="primary" type="submit">Load State</button>
          </form>
          <p class="small">Loading a new state replaces current appointments. Use Save State first if you want a backup.</p>
          <p class="small">Sample data source is local in development and GitHub-hosted in production.</p>
        </div>
      </div>
    </div>
    <script type="module">
      async function loadAppEntrypoint() {
        let version = String(Date.now());

        try {
          const response = await fetch(`./version.json?bootstrapTs=${Date.now()}`, {
            cache: 'no-store',
            headers: {
              'Cache-Control': 'no-cache',
              Pragma: 'no-cache',
            },
          });

          if (response.ok) {
            const manifest = await response.json();
            if (manifest?.version) {
              version = String(manifest.version);
            }
            if (typeof window !== 'undefined') {
              window.__APP_BUILD_INFO__ = manifest;
            }
          }
        } catch {
          // fallback to timestamp version to bypass stale JS cache
        }

        await import(`./src/main.js?v=${encodeURIComponent(version)}`);
      }

      loadAppEntrypoint();
    </script>
  </body>
</html>
